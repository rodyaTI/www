/**
 * @name YandexClusterer for Yandex Maps.
 * @version 1.1.1 [March 02, 2012]
 * @author Alexander Shabunevich [http://aether.ru]
 * http://beholder.bitbucket.org/yandex.clusterer/
 *
 * Based on MarkerClustererPlus for Google Maps V3 by Gary Little
 */
function YandexClusterer(map,markers,opts){this.map=map;this.bounds=null;this.clusters=[];this.markers=markers||[];this.zoom=null;this.map.YandexClusterer=this;this.yandexObjectManager=new YMaps.ObjectManager();this.map.addOverlay(this.yandexObjectManager);opts=opts||{};this.max_zoom=opts.max_zoom||0;this.grid=opts.grid||60;this.min_size=opts.min_size||2;this.centered=opts.centered||false;this.batch=opts.batch||400;this.imagePath_=opts.imagePath||YandexClusterer.IMAGE_PATH;this.imageExtension_=opts.imageExtension||YandexClusterer.IMAGE_EXTENSION;this.imageSizes_=opts.imageSizes||YandexClusterer.IMAGE_SIZES;this.styles=opts.styles||this.generateClusterStyles();this.printable=opts.printable||false;if(this.map._yandexClustererEvents){for(event in this.map._yandexClustererEvents){this.map._yandexClustererEvents[event].cleanup()}}this.map._yandexClustererEvents={};this.map._yandexClustererEvents['update']=YMaps.Events.observe(this.map,this.map.Events.Update,function(){this.repaint()},this);this.map._yandexClustererEvents['move']=YMaps.Events.observe(this.map,this.map.Events.MoveEnd,function(){this.redraw()},this);this.repaint()}YandexClusterer.prototype.setMarkers=function(markers){this.markers=markers};YandexClusterer.prototype.clearMarkers=function(){var l=this.markers.length;while(l--){var marker=this.markers[l];this.map.removeOverlay(marker);marker.isAdded=false;if(marker.isOnMap){marker.isOnMap=false}}this.yandexObjectManager.removeAll();l=this.clusters.length;while(l--){this.clusters[l].remove()}this.clusters=[]};YandexClusterer.prototype.repaint=function(){this.clearMarkers();this.redraw()};YandexClusterer.prototype.redraw=function(){this.createClusters(0)};YandexClusterer.prototype.createClusters=function(iter){var self=this;var i=iter;var length=this.markers.length;var iter_last=Math.min(iter+this.batch,length);if(iter===0){this.bounds=this.extendBounds(this.map.getBounds());this.zoom=this.map.getZoom();if(typeof this.timerRefStatic!=="undefined"){clearTimeout(this.timerRefStatic);delete this.timerRefStatic}}for(;i<iter_last;i++){var marker=this.markers[i];if(!marker.isAdded&&this.bounds.contains(marker.getCoordPoint())){this.addToCluster(marker)}}if(iter_last<length){this.timerRefStatic=setTimeout(function(){self.createClusters(iter_last)},0)}else{delete this.timerRefStatic;setTimeout(function(){self.updateClusterIcons()},0)}};YandexClusterer.prototype.extendBounds=function(bounds){var converter=this.map.converter,rtPix,lbPix,ne,sw;rtPix=converter.coordinatesToMapPixels(bounds.getRightTop());rtPix.x+=this.grid;rtPix.y-=this.grid;lbPix=converter.coordinatesToMapPixels(bounds.getLeftBottom());lbPix.x-=this.grid;lbPix.y+=this.grid;ne=converter.mapPixelsToCoordinates(rtPix);sw=converter.mapPixelsToCoordinates(lbPix);return new YMaps.GeoBounds(sw,ne)};YandexClusterer.prototype.addToCluster=function(marker){var d,cluster,center,l=this.clusters.length;var distance=40000;var clusterToAddTo=null;while(l--){cluster=this.clusters[l];if(cluster.center){d=this.distanceBetween(cluster.center,marker.getCoordPoint());if(d<distance){distance=d;clusterToAddTo=cluster}}}if(clusterToAddTo&&clusterToAddTo.isMarkerInBounds(marker)){clusterToAddTo.addMarker(marker)}else{cluster=new YandexCluster(this);cluster.addMarker(marker);this.clusters.push(cluster)}};YandexClusterer.prototype.distanceBetween=function(p1,p2){return p1.distance(p2)/1000};YandexClusterer.prototype.updateClusterIcons=function(){var self=this,l=this.clusters.length,max_zoom=this.getMaxZoom(),max_map_zoom=this.map.getZoom();while(l--){var cluster=this.clusters[l];count=cluster.markers.length;if(max_map_zoom>=max_zoom){var i=cluster.markers.length;while(i--){var marker=cluster.markers[i];if(!marker.isOnMap){this.yandexObjectManager.add(marker,this.zoom,this.zoom);marker.isOnMap=true}}continue}else if(count<this.min_size){var i=cluster.markers.length;while(i--){var marker=cluster.markers[i];if(!marker.isOnMap){this.yandexObjectManager.add(marker,this.zoom,this.zoom);marker.isOnMap=true}}continue}else{var i=cluster.markers.length;while(i--){var marker=cluster.markers[i];this.map.removeOverlay(marker);marker.isOnMap=false}}cluster.showIcon()}};YandexClusterer.prototype.getMaxZoom=function(){return this.max_zoom||this.map.getMaxZoom()};YandexClusterer.prototype.getClusterStyle=function(cluster){return this.styles[cluster.getIconStyleIndex(this.getStylesCount())]};YandexClusterer.prototype.generateClusterStyles=function(){var styles=[];for(var i=0;i<this.getStylesCount();i++){styles.push(this.genStyleForIndex(i))}return styles};YandexClusterer.prototype.genStyleForIndex=function(index){var size=this.imageSizes_[index];var iconPath=this.imagePath_+(index+1)+this.imageExtension_;var style={icon:iconPath,height:size,width:size,offset:[-parseInt(size/2,10),-parseInt(size/2,10)],textColor:'#000000',textSize:11};return style};YandexClusterer.prototype.getStylesCount=function(){return this.imageSizes_.length};YandexClusterer.IMAGE_PATH="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclustererplus/images/m";YandexClusterer.IMAGE_EXTENSION=".png";YandexClusterer.IMAGE_SIZES=[53,56,66,78,90];function YandexCluster(clusterOwner){this.clustererObject=clusterOwner;this.yandexObjectManager=clusterOwner.yandexObjectManager;this.map=clusterOwner.map;this.center=null;this.markers=[];this.markers_bounds=new YMaps.GeoCollectionBounds();this.bounds=null;this.min_size=clusterOwner.min_size;this.point=null}YandexCluster.prototype.addMarker=function(marker){var count,i,zoom=this.map.getZoom();if(marker.isAdded)return false;if(!this.center){this.center=marker.getCoordPoint();this.bounds=this.calculateBounds()}else if(this.clustererObject.centered){var l=this.markers.length+1,m_coord=marker.getCoordPoint();var lat=(this.center.getLat()*(l-1)+m_coord.getLat())/l;var lng=(this.center.getLng()*(l-1)+m_coord.getLng())/l;this.center=new YMaps.GeoPoint(lng,lat);this.bounds=this.calculateBounds()}marker.isAdded=true;this.markers.push(marker);this.markers_bounds.add(marker.getGeoPoint());return true};YandexCluster.prototype.getClusterBounds=function(){return this.markers_bounds};YandexCluster.prototype.calculateBounds=function(){var bounds=new YMaps.GeoCollectionBounds(this.center);return this.clustererObject.extendBounds(bounds)};YandexCluster.prototype.isMarkerInBounds=function(marker){return this.bounds.contains(marker.getCoordPoint())};YandexCluster.prototype.showIcon=function(){var self=this,position=new YMaps.GeoPoint(this.center.getLng(),this.center.getLat());if(this.point){this.yandexObjectManager.remove(this.point)}if(this.clustererObject.printable){var template=new YMaps.Template('<div style="cursor:pointer;position:relative;line-height:$[style.iconStyle.size.y]px;height:$[style.iconStyle.size.y]px;width:$[style.iconStyle.size.x]px;text-align:center"><img src="$[style.iconStyle.href]" alt="" style="position:absolute;left:0;top:0"><span style="position:relative;font-weight:bold;font-size:$[textSize|12]px;color:$[textColor|#000]">$[markersCount|0]</span></div>')}else{var template=new YMaps.Template('<div style="cursor:pointer;position:relative;line-height:$[style.iconStyle.size.y]px;height:$[style.iconStyle.size.y]px;width:$[style.iconStyle.size.x]px;text-align:center;background:url($[style.iconStyle.href]) no-repeat;font-weight:bold;font-size:$[textSize|12]px;color:$[textColor|#000]">$[markersCount|0]</div>')}var clusterStyle=this.clustererObject.getClusterStyle(this);var style=new YMaps.Style();style.iconStyle=new YMaps.IconStyle(template);style.iconStyle.href=clusterStyle.icon;style.iconStyle.size=new YMaps.Point(clusterStyle.width,clusterStyle.height);style.iconStyle.offset=new YMaps.Point(clusterStyle.offset[0],clusterStyle.offset[1]);this.point=new YMaps.Placemark(position,{style:style,hasBalloon:false});this.point.markersCount=this.markers.length;this.point.textSize=clusterStyle.textSize;this.point.textColor=clusterStyle.textColor;YMaps.Events.observe(this.point,this.point.Events.Click,function(){this.map.setBounds(this.getClusterBounds());if(this.clustererObject.getMaxZoom()<this.map.getZoom()){this.map.setZoom(this.clustererObject.getMaxZoom()+1)}},this);var zoom=this.map.getZoom();this.yandexObjectManager.add(this.point,zoom,zoom)};YandexCluster.prototype.remove=function(){this.markers=[];this.markers_bounds.clear();if(this.point){this.point=null}};YandexCluster.prototype.getIconStyleIndex=function(styles_num){var index=-1;var count=this.markers.length.toString();var dv=count;while(dv!==0){dv=parseInt(dv/10,10);index++}index=Math.min(index,styles_num-1);return index};
